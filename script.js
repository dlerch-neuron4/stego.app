var gImageURL="";var gB64image="";var gUIState="start";var gPyodide=null;const downloadButton=document.getElementById("download-button");const nextButton=document.getElementById("next-button");const hideButton=document.getElementById("hide-button");const hide2Button=document.getElementById("hide2-button");const extractButton=document.getElementById("extract-button");const extract2Button=document.getElementById("extract2-button");const restartButton=document.getElementById("restart-button");const backButton=document.getElementById("back-button");const sendButton=document.getElementById("send-button");const feedbackButton=document.getElementById("feedback-button");const message=document.getElementById("message");const info=document.getElementById("info");const log=document.getElementById("log");const method=document.getElementById("method");const cookieBanner=document.getElementById("cookie-banner");const acceptButton=document.getElementById("accept-cookies");const rejectButton=document.getElementById("reject-cookies");const infoLink=document.getElementById("info-link");const containerInfo=document.getElementById("container-info");function hideElement(elementId){const element=document.getElementById(elementId);if(element){element.style.display="none"}}function showElement(elementId,display="block"){const element=document.getElementById(elementId);if(element){element.style.display=display}}function disableElement(elementId){document.getElementById(elementId).disabled=true}function enableElement(elementId){document.getElementById(elementId).disabled=false}function drawImageOnCanvas(imageSrc,canvasId){const canvas=document.getElementById(canvasId);if(!canvas){console.error(`No se encontrÃ³ el canvas con id: ${canvasId}`);return}const ctx=canvas.getContext("2d");const image=new Image;image.src=imageSrc;image.onload=function(){canvas.width=image.width;canvas.height=image.height;ctx.drawImage(image,0,0,canvas.width,canvas.height)};image.onerror=function(){console.error(`No se pudo cargar la imagen: ${imageSrc}`)}}function imageToURL(src,callback,outputFormat){var img=new Image;img.crossOrigin="Anonymous";img.onload=function(){var canvas=document.getElementById("cover-image");var ctx=canvas.getContext("2d");var dataURL;canvas.height=this.naturalHeight;canvas.width=this.naturalWidth;ctx.drawImage(this,0,0);dataURL=canvas.toDataURL(outputFormat);callback(dataURL)};img.src=src}function downloadBase64Image(base64Image,filename){const link=document.createElement("a");link.href=base64Image;link.download=filename;document.body.appendChild(link);link.click();document.body.removeChild(link)}function fileUpload(e){var file=e.target.files[0];if(!file){return}if(!file.type.startsWith("image/")){return}var reader=new FileReader;reader.onload=function(e){var img=new Image;img.src=e.target.result;img.onload=function(){if(img.width>1080||img.height>1080){if(gUIState.includes("hide"))log.textContent="WARNING: Image too large. It will be resized during embedding."}imageToURL(e.target.result,function(iurl){gImageURL=iurl})}};reader.readAsDataURL(file);if(gUIState=="hide-step-1")setUI("hide-step-2");else setUI("extract-step-2")}function setUI(ui){gUIState=ui;gtagEvent(ui);showElement("info");hideElement("container-info");hideElement("download-button");hideElement("upload-button-label");hideElement("upload-button");hideElement("loading");hideElement("password");hideElement("hide-button");hideElement("extract-button");hideElement("hide2-button");hideElement("extract2-button");hideElement("feedback-button");hideElement("send-button");hideElement("next-button");hideElement("navigation");hideElement("message");hideElement("cover-image");hideElement("method");enableElement("back-button");enableElement("restart-button");message.removeAttribute("readonly");message.placeholder="Enter your message here...";info.textContent="StegoApp: Hide your secret messages inside pictures";log.innerHTML="";if(ui=="start"){message.value="";drawImageOnCanvas("images/logo.png","cover-image");document.getElementById("upload-button").value="";showElement("cover-image");showElement("hide-button");showElement("extract-button");log.textContent="Click one of the options below to hide or extract information in an image."}else if(ui=="hide-step-1"){drawImageOnCanvas("images/logo.png","cover-image");document.getElementById("upload-button").value="";showElement("cover-image");showElement("upload-button-label");showElement("navigation","flex");log.textContent="Select the image in which you want to hide the information."}else if(ui=="hide-step-2"){showElement("cover-image");showElement("upload-button-label");showElement("next-button");showElement("navigation","flex");log.textContent="Click Next or choose another image"}else if(ui=="hide-step-3"){showElement("hide2-button");showElement("method");showElement("password");showElement("navigation","flex");showElement("message");log.textContent="Enter a message and password and select the steganography method."}else if(ui=="hide-step-4"){showElement("cover-image");showElement("loading");disableElement("back-button");disableElement("restart-button");showElement("navigation","flex")}else if(ui=="hide-step-5"){showElement("cover-image");showElement("download-button");showElement("navigation","flex");log.textContent="The message has been hidden!"}else if(ui=="extract-step-1"){drawImageOnCanvas("images/logo.png","cover-image");document.getElementById("upload-button").value="";showElement("cover-image");showElement("upload-button-label");showElement("navigation","flex");log.textContent="Select the image from which you want to extract information."}else if(ui=="extract-step-2"){showElement("cover-image");showElement("upload-button-label");showElement("next-button");showElement("navigation","flex");log.textContent="Click Next or choose another image"}else if(ui=="extract-step-3"){showElement("cover-image");showElement("extract2-button");showElement("password");showElement("method");showElement("navigation","flex");log.textContent="Select the steganography method and enter a password";hideElement("info")}else if(ui=="extract-step-4"){showElement("cover-image");showElement("loading");disableElement("back-button");disableElement("restart-button");showElement("navigation","flex")}else if(ui=="extract-step-5"){showElement("cover-image");showElement("navigation","flex");showElement("message");hideElement("info");message.setAttribute("readonly",true)}else if(ui=="info-step-1"){hideElement("info");showElement("container-info");showElement("navigation","flex");showElement("feedback-button");disableElement("back-button");containerInfo.innerHTML=`<br>
      <center>
      <h1>StegoApp</h1>
      <h3>Hide your secret messages<br>inside pictures</h3><br>
      Developed by <strong>StegoLabs</strong>, version <strong>beta</strong>.<br><br>
      Visit us at <a href="https://stegolabs.com" target="_blank">stegolabs.com</a><br><br>
      <hr>
      <br>
      <h3>Key Features:</h3>
      </center>
      <ul>
     <li><strong><u>Robustness:</u></strong> 
         Share images on most social media without losing the hidden message, even after compression.</li><br>
     <li><strong><u>Privacy:</u></strong> 
         Everything runs locally in your browser. No image, secret, or password is sent anywhere.</li><br>
     <li><strong><u>Cryptography:</u></strong> 
          Messages encrypted with AES-256 using PBKDF2 key derivation.</li><br>
     </ul>
      `}else if(ui=="feedback"){hideElement("info");showElement("container-info");showElement("navigation","flex");showElement("message");showElement("send-button");enableElement("message");containerInfo.innerHTML=`<br>
      <center>
      <h1>StegoApp</h1>
      <h3>Hide your secret messages<br>inside pictures</h3>
      Visit us at <a href="https://stegolabs.com" target="_blank">stegolabs.com</a><br><br>
      <hr><br>
      At StegoLabs, your feedback is important to us. <br><br>
      We understand your privacy matters, so we offer a way to share your thoughts anonymously.<br><br>
      `;message.placeholder="Tell us what you think..."}}function gtagEvent(eventName){if(localStorage.getItem("cookieConsent")=="accepted"){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("event",eventName)}}function manageCookies(){if(!localStorage.getItem("cookieConsent")){cookieBanner.style.display="block"}acceptButton.addEventListener("click",function(){localStorage.setItem("cookieConsent","accepted");cookieBanner.style.display="none";console.log("Configure analytics");window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date);gtag("config","G-3WK793L93Z");gtag("event","main")});rejectButton.addEventListener("click",function(){localStorage.setItem("cookieConsent","rejected");cookieBanner.style.display="none"});if(localStorage.getItem("cookieConsent")=="accepted"){console.log("Analitics enabled");window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("event","main")}}function registerSW(){if("serviceWorker"in navigator){window.addEventListener("load",function(){navigator.serviceWorker.register("service-worker.js").then(function(registration){console.log("Service Worker registered:",registration.scope)}).catch(function(error){console.log("Service worker register failed:",error)})})}}async function loadPycFile(fileName){const response=await fetch(`${fileName}`);if(!response.ok){throw new Error(`Error loading file: ${response.statusText}`)}const buffer=await response.arrayBuffer();const pycData=new Uint8Array(buffer);gPyodide.FS.writeFile(`${fileName}`,pycData)}async function loadPythonFile(fileName){const response=await fetch(`${fileName}`);if(!response.ok){throw new Error(`Error loading file: ${response.statusText}`)}const fileContent=await response.text();gPyodide.FS.writeFile(fileName,fileContent)}async function loadPyodideAndPackages(){try{var content=log.textContent;log.style.textAlign="left";log.style.paddingLeft="5%";content+="<br>";content+="<ul>";log.innerHTML=content;content+="<li>Execution engine";log.innerHTML=content;gPyodide=await loadPyodide({indexURL:"pyodide-0.26.2"});content+=" &#10004; <br>";log.innerHTML=content;content+="<li>Package manager";log.innerHTML=content;await gPyodide.loadPackage("micropip");const micropip=gPyodide.pyimport("micropip");content+=" &#10004; <br>";log.innerHTML=content;content+="<li>Numerical library";log.innerHTML=content;await micropip.install("numpy");content+=" &#10004;";log.innerHTML=content;content+="<li>Scientific computing library";log.innerHTML=content;await micropip.install("scipy");content+=" &#10004";log.innerHTML=content;content+="<li>Error correcting codes library";log.innerHTML=content;await micropip.install("pyodide-0.26.2/reedsolo-2.0.10-py3-none-any.whl");content+=" &#10004;";log.innerHTML=content;content+="<li>Cryptography library";log.innerHTML=content;await micropip.install("pycryptodome");content+=" &#10004;";log.innerHTML=content;content+="<li>Image processing library";log.innerHTML=content;await micropip.install("pillow");content+=" &#10004;";log.innerHTML=content;content+="<li>StegoApp library";log.innerHTML=content;await loadPycFile("stegoapp.pyc");content+=" &#10004;<br>";log.innerHTML=content;content+="</li>";log.innerHTML=content;log.style.textAlign="center";log.style.removeProperty("padding-left")}catch(error){console.error("Error loading Pyodide or packages:",error);throw error}}async function hide(){console.log("hide");try{let response=await fetch("hide.py",{cache:"no-store"});if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`)}let pycode=await response.text();method_version=method.options[method.selectedIndex].id;console.log("method_version:",method_version);gPyodide.globals.set("g_image_url",gImageURL);gPyodide.globals.set("g_password",password.value);gPyodide.globals.set("g_message",method_version+message.value);gPyodide.runPython(pycode);gB64image=gPyodide.globals.get("g_b64image");setUI("hide-step-5");if(gB64image=="ERR_EMB"){hideElement("download-button");log.innerHTML="The message could not be embedded in the selected image.<br><br> Please try using a different image.";gtagEvent("hide-err-emb")}else if(gB64image=="ERR_TOO_LONG"){hideElement("download-button");log.innerHTML="The message is too long for this image.<br><br>  Please try a shorter one.";gtagEvent("hide-err-toolong")}else{gtagEvent("hide-ok")}}catch(error){console.error("Error executing Python script:",error)}}async function extract(){console.log("extract");try{let response=await fetch("extract.py",{cache:"no-store"});if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`)}let pycode=await response.text();method_version=method.options[method.selectedIndex].id;console.log("method_version:",method_version);gPyodide.globals.set("g_image_url",gImageURL);gPyodide.globals.set("g_password",password.value);gPyodide.runPython(pycode);extracted_msg=gPyodide.globals.get("g_message");setUI("extract-step-5");if(extracted_msg.startsWith(method_version)){log.textContent="Message successfully extracted";message.value=extracted_msg.slice(3);gtagEvent("extract-ok")}else{hideElement("message");log.innerHTML="The message could not be extracted.<br><br> The password or steganography method is incorrect.";gtagEvent("extract-err")}}catch(error){console.error("Error executing Python script:",error)}}document.getElementById("upload-button").addEventListener("change",fileUpload,false);downloadButton.addEventListener("click",function(){downloadBase64Image(gB64image,"image.png")});hideButton.addEventListener("click",function(){setUI("hide-step-1")});extractButton.addEventListener("click",function(){setUI("extract-step-1")});nextButton.addEventListener("click",function(){if(gUIState=="hide-step-2")setUI("hide-step-3");else setUI("extract-step-3")});hide2Button.addEventListener("click",function(){message.style.border="";password.style.border="";if(message.value.trim()==""){message.style.border="1px solid red";return}if(password.value.trim().length<6){password.style.border="1px solid red";return}setUI("hide-step-4");log.textContent="Running, this might take a while ...";setTimeout(hide,500)});extract2Button.addEventListener("click",function(){password.style.border="";if(password.value.trim().length<6){password.style.border="1px solid red";return}setUI("extract-step-4");log.textContent="Running, this might take a while ...";setTimeout(extract,500)});restartButton.addEventListener("click",function(){setUI("start")});backButton.addEventListener("click",function(){if(gUIState=="hide-step-1")setUI("start");else if(gUIState=="hide-step-2")setUI("hide-step-1");else if(gUIState=="hide-step-3")setUI("hide-step-2");else if(gUIState=="hide-step-4")setUI("hide-step-3");else if(gUIState=="hide-step-5")setUI("hide-step-3");else if(gUIState=="extract-step-1")setUI("start");else if(gUIState=="extract-step-2")setUI("extract-step-1");else if(gUIState=="extract-step-3")setUI("extract-step-2");else if(gUIState=="extract-step-4")setUI("extract-step-3");else if(gUIState=="extract-step-5")setUI("extract-step-3");else if(gUIState=="info-step-1")setUI("start");else if(gUIState=="feedback")setUI("info-step-1")});feedbackButton.addEventListener("click",function(){setUI("feedback")});sendButton.addEventListener("click",function(){console.log("send feedback");const data=new URLSearchParams;data.append("message",message.value);fetch("https://api.neuron4.com:8000/feedback.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:data}).then(response=>{if(response.ok){hideElement("message");hideElement("send-button");containerInfo.innerHTML+="<br><hr><br><br><center><strong>Thanks for your feedback!</strong></center>"}else{hideElement("message");hideElement("send-button");containerInfo.innerHTML+="<br><hr><br><br><center><strong>An error occurred, please try again later.</strong></center>"}}).catch(error=>{console.error("Error: ",error);hideElement("message");hideElement("send-button");containerInfo.innerHTML+="<br><hr><br><br><center><strong>An error occurred, please try again later.</strong></center>"})});infoLink.addEventListener("click",function(){setUI("info-step-1")});message.addEventListener("input",function(){if(message.value.trim().length>=1){message.style.border=""}});password.addEventListener("input",function(){if(password.value.trim().length>=6){password.style.border=""}});document.addEventListener("DOMContentLoaded",function(){registerSW();setUI("start");showElement("loading");hideElement("hide-button");hideElement("extract-button");log.innerHTML="Loading ...";loadPyodideAndPackages().then(function(){hideElement("loading");showElement("hide-button");showElement("extract-button");log.textContent="Click one of the options below to hide or extract information in an image.";showElement("info-link");manageCookies()})});